<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chalpus Game Store Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-button-color: #00bad4;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--tg-theme-button-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .search-bar { background: var(--tg-theme-secondary-bg-color); }
        #admin-panel { transition: transform 0.4s ease; transform: translateY(100%); }
        #admin-panel.open { transform: translateY(0); }
        .banner-container::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-24">

    <!-- Y√ºkleme Ekranƒ± -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 text-sm font-bold text-gray-400 animate-pulse">Maƒüaza Y√ºkleniyor...</p>
        <p id="error-msg" class="mt-2 text-xs text-red-500 hidden text-center px-6"></p>
    </div>

    <!-- Ban Ekranƒ± -->
    <div id="banned-screen" class="fixed inset-0 bg-white z-[9999] hidden flex-col items-center justify-center p-10 text-center">
        <div class="text-6xl mb-4">üö´</div>
        <h2 class="text-2xl font-bold">Eri≈üim Engellendi</h2>
    </div>

    <!-- Ana ƒ∞√ßerik -->
    <div id="app-container" class="max-w-md mx-auto px-4 pt-4 opacity-0 transition-opacity duration-500">
        
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-cyan-100">?</div>
                <div>
                    <p class="text-xs text-gray-400 font-medium">Ho≈ü geldin,</p>
                    <h1 id="user-name" class="font-bold text-gray-800 leading-tight">Oyuncu</h1>
                </div>
            </div>
        </header>

        <div class="search-bar flex items-center px-4 py-3 rounded-2xl mb-6">
            <span class="mr-2">üîç</span>
            <input type="text" id="search-input" placeholder="Oyun ara..." class="bg-transparent border-none outline-none w-full text-sm font-medium">
        </div>

        <!-- Bannerlar -->
        <div class="relative mb-8 overflow-hidden rounded-[2rem] shadow-xl shadow-gray-100 hidden" id="banner-wrapper">
            <div id="banner-list" class="banner-container flex overflow-x-auto scroll-smooth snap-x snap-mandatory"></div>
            <div id="banner-dots" class="absolute bottom-4 left-0 right-0 flex justify-center gap-1.5"></div>
        </div>

        <!-- Kategoriler -->
        <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-4" id="category-list">
            <button class="category-pill active px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('All', this)">T√ºm√º</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Aksiyon', this)">Aksiyon</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Bulmaca', this)">Bulmaca</button>
        </div>

        <!-- Oyun Listesi -->
        <div id="game-grid" class="grid grid-cols-1 gap-4"></div>
    </div>

    <!-- Admin Butonu -->
    <button id="admin-float-btn" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-gray-900 text-white rounded-2xl shadow-2xl items-center justify-center z-50" onclick="toggleAdminPanel(true)">‚öôÔ∏è</button>

    <!-- Admin Paneli -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-[100] flex flex-col pt-safe">
        <div class="px-6 py-4 flex items-center justify-between border-b">
            <h2 class="text-xl font-extrabold italic">ADMIN PANEL</h2>
            <button onclick="toggleAdminPanel(false)" class="p-2 bg-gray-100 rounded-xl">‚úï</button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-20 pt-4">
            <div class="bg-gray-50 p-5 rounded-[2rem] space-y-4">
                <div class="flex gap-2">
                    <div class="flex-1 h-20 border-2 border-dashed rounded-2xl flex items-center justify-center bg-white cursor-pointer" onclick="document.getElementById('icon-input').click()">
                        <img id="icon-preview" class="hidden w-full h-full object-cover rounded-2xl">
                        <span id="icon-hint" class="text-[10px] text-gray-400 font-bold">ƒ∞KON</span>
                    </div>
                    <input type="file" id="icon-input" class="hidden" accept="image/*" onchange="previewImage(this, 'icon')">
                </div>
                <input type="text" id="add-name" placeholder="Oyun Adƒ±" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200">
                <input type="text" id="add-link" placeholder="t.me/BotLinki" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200">
                <button onclick="createNewGame()" id="save-btn" class="w-full py-4 bg-cyan-500 text-white rounded-2xl font-black">MAƒûAZAYA EKLE</button>
            </div>
            <div id="admin-inventory" class="mt-6 space-y-3"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, addDoc, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth;
        const tg = window.Telegram.WebApp;
        const ADMIN_ID = "8392479231";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-store-pro';
        
        let allGames = [];
        let currentIcon = "";

        async function startApp() {
            try {
                // G√ºvenli Firebase Yapƒ±landƒ±rmasƒ±
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);
                
                const tgUser = tg.initDataUnsafe?.user;
                if (tgUser) {
                    document.getElementById('user-name').innerText = tgUser.first_name;
                    document.getElementById('user-avatar').innerText = tgUser.first_name[0];
                    if (tgUser.id.toString() === ADMIN_ID) {
                        document.getElementById('admin-float-btn').classList.remove('hidden');
                    }
                }

                // Verileri Dinle
                const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                onSnapshot(gamesRef, (snap) => {
                    allGames = [];
                    snap.forEach(d => allGames.push({ id: d.id, ...d.data() }));
                    renderGames();
                    renderAdminInventory();
                    hideLoading();
                }, (err) => {
                    showError("Veri eri≈üim hatasƒ±: " + err.message);
                });

            } catch (e) {
                showError("Yapƒ±landƒ±rma hatasƒ±: " + e.message);
            }
        }

        function hideLoading() {
            const loader = document.getElementById('loading-overlay');
            const container = document.getElementById('app-container');
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.classList.add('hidden');
                container.classList.remove('opacity-0');
            }, 500);
        }

        function showError(msg) {
            const errEl = document.getElementById('error-msg');
            errEl.innerText = msg;
            errEl.classList.remove('hidden');
        }

        window.createNewGame = async () => {
            const name = document.getElementById('add-name').value;
            const link = document.getElementById('add-link').value;
            const btn = document.getElementById('save-btn');
            if(!name || !link) return tg.showAlert("Eksik bilgi!");

            btn.disabled = true;
            try {
                const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                await addDoc(gamesRef, {
                    name, link, icon: currentIcon || `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                    clicks: 0, created_at: serverTimestamp()
                });
                tg.showAlert("Eklendi!");
                toggleAdminPanel(false);
            } catch (e) { tg.showAlert(e.message); }
            btn.disabled = false;
        };

        window.previewImage = (input, type) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentIcon = e.target.result;
                document.getElementById('icon-preview').src = currentIcon;
                document.getElementById('icon-preview').classList.remove('hidden');
                document.getElementById('icon-hint').classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.toggleAdminPanel = (s) => document.getElementById('admin-panel').classList.toggle('open', s);

        function renderGames() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            allGames.forEach(g => {
                grid.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-white border rounded-[2rem] custom-shadow" onclick="window.open('${g.link}', '_blank')">
                        <div class="flex items-center gap-4">
                            <img src="${g.icon}" class="w-16 h-16 rounded-2xl object-cover">
                            <h3 class="font-bold text-gray-800">${g.name}</h3>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-cyan-50 flex items-center justify-center text-cyan-500 font-bold">‚ñ∂</div>
                    </div>`;
            });
        }

        function renderAdminInventory() {
            const inv = document.getElementById('admin-inventory');
            inv.innerHTML = "";
            allGames.forEach(g => {
                inv.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                        <span class="text-sm font-bold">${g.name}</span>
                        <button onclick="deleteDoc(doc(db, 'artifacts', '${appId}', 'public', 'data', 'games', '${g.id}'))" class="text-red-500 text-xs">Kaldƒ±r</button>
                    </div>`;
            });
        }

        // 5 Saniye i√ßinde y√ºklenmezse hata g√∂ster (Zaman a≈üƒ±mƒ± kontrol√º)
        setTimeout(() => {
            if (!document.getElementById('loading-overlay').classList.contains('hidden')) {
                showError("Baƒülantƒ± zaman a≈üƒ±mƒ±na uƒüradƒ±. L√ºtfen internetinizi kontrol edin.");
            }
        }, 8000);

        window.addEventListener('DOMContentLoaded', startApp);
    </script>
</body>
</html>
