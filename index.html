<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chalpus Game Store Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-button-color: #00bad4;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        .custom-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .search-bar { background: var(--tg-theme-secondary-bg-color); }
        #admin-panel { transition: transform 0.4s ease; transform: translateY(100%); }
        #admin-panel.open { transform: translateY(0); }
        
        /* Oyun kartlarƒ± i√ßin y√ºkleme iskeleti efekti */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="pb-24">

    <!-- Ana ƒ∞√ßerik (Y√ºkleme ekranƒ± kaldƒ±rƒ±ldƒ±, direkt g√∂r√ºn√ºr) -->
    <div id="app-container" class="max-w-md mx-auto px-4 pt-4 transition-opacity duration-500">
        
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-cyan-100">?</div>
                <div>
                    <p class="text-xs text-gray-400 font-medium">Ho≈ü geldin,</p>
                    <h1 id="user-name" class="font-bold text-gray-800 leading-tight">Oyuncu</h1>
                </div>
            </div>
            <!-- Status Indicator -->
            <div id="connection-status" class="text-[10px] font-bold px-2 py-1 rounded-lg bg-yellow-100 text-yellow-600">Baƒülanƒ±yor...</div>
        </header>

        <div class="search-bar flex items-center px-4 py-3 rounded-2xl mb-6">
            <span class="mr-2">üîç</span>
            <input type="text" id="search-input" placeholder="Oyun ara..." class="bg-transparent border-none outline-none w-full text-sm font-medium">
        </div>

        <!-- Kategoriler -->
        <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-4" id="category-list">
            <button class="category-pill active px-5 py-2 rounded-full text-sm font-bold bg-gray-900 text-white" onclick="filterCategory('All', this)">T√ºm√º</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Aksiyon', this)">Aksiyon</button>
        </div>

        <!-- Oyun Listesi (Ba≈ülangƒ±√ßta bo≈ü veya iskelet g√∂r√ºnebilir) -->
        <div id="game-grid" class="grid grid-cols-1 gap-4">
            <!-- ƒ∞skelet Y√ºkleme G√∂r√ºn√ºm√º -->
            <div class="skeleton-item flex items-center justify-between p-4 bg-white border rounded-[2rem] opacity-50">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-2xl skeleton"></div>
                    <div class="h-4 w-24 rounded skeleton"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Butonu -->
    <button id="admin-float-btn" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-gray-900 text-white rounded-2xl shadow-2xl items-center justify-center z-50" onclick="toggleAdminPanel(true)">‚öôÔ∏è</button>

    <!-- Admin Paneli -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-[100] flex flex-col pt-safe">
        <div class="px-6 py-4 flex items-center justify-between border-b">
            <h2 class="text-xl font-extrabold italic">ADMIN PANEL</h2>
            <button onclick="toggleAdminPanel(false)" class="p-2 bg-gray-100 rounded-xl">‚úï</button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-20 pt-4">
            <div class="bg-gray-50 p-5 rounded-[2rem] space-y-4">
                <div class="flex gap-2">
                    <div class="flex-1 h-20 border-2 border-dashed rounded-2xl flex items-center justify-center bg-white cursor-pointer" onclick="document.getElementById('icon-input').click()">
                        <img id="icon-preview" class="hidden w-full h-full object-cover rounded-2xl">
                        <span id="icon-hint" class="text-[10px] text-gray-400 font-bold">ƒ∞KON SE√á</span>
                    </div>
                    <input type="file" id="icon-input" class="hidden" accept="image/*" onchange="previewImage(this)">
                </div>
                <input type="text" id="add-name" placeholder="Oyun Adƒ±" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200">
                <input type="text" id="add-link" placeholder="t.me/BotLinki" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200">
                <button onclick="createNewGame()" id="save-btn" class="w-full py-4 bg-cyan-500 text-white rounded-2xl font-black shadow-lg shadow-cyan-100">MAƒûAZAYA EKLE</button>
            </div>
            <div id="admin-inventory" class="mt-6 space-y-3"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, serverTimestamp, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth;
        const tg = window.Telegram.WebApp;
        const ADMIN_ID = "8392479231";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-store-pro';
        
        let allGames = [];
        let currentIcon = "";
        let currentUser = null;

        async function startApp() {
            try {
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                tg.ready();
                tg.expand();

                // Auth Ba≈ülat
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('connection-status').innerText = "Baƒülƒ±";
                        document.getElementById('connection-status').className = "text-[10px] font-bold px-2 py-1 rounded-lg bg-green-100 text-green-600";
                        setupListeners();
                        setupUserData();
                    }
                });

            } catch (e) {
                console.error("Ba≈ülatma hatasƒ±:", e);
                document.getElementById('connection-status').innerText = "Hata!";
                document.getElementById('connection-status').className = "text-[10px] font-bold px-2 py-1 rounded-lg bg-red-100 text-red-600";
            }
        }

        function setupUserData() {
            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser) {
                document.getElementById('user-name').innerText = tgUser.first_name;
                document.getElementById('user-avatar').innerText = tgUser.first_name[0];
                if (tgUser.id.toString() === ADMIN_ID) {
                    document.getElementById('admin-float-btn').classList.remove('hidden');
                    document.getElementById('admin-float-btn').classList.add('flex');
                }
            }
        }

        function setupListeners() {
            const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
            onSnapshot(gamesRef, (snap) => {
                allGames = [];
                snap.forEach(d => allGames.push({ id: d.id, ...d.data() }));
                renderGames();
                renderAdminInventory();
            }, (err) => {
                console.error("Firestore hatasƒ±:", err);
            });
        }

        window.createNewGame = async () => {
            if (!currentUser) return tg.showAlert("Oturum hazƒ±r deƒüil!");
            const name = document.getElementById('add-name').value;
            const link = document.getElementById('add-link').value;
            const btn = document.getElementById('save-btn');
            
            if(!name || !link) return tg.showAlert("L√ºtfen t√ºm alanlarƒ± doldurun!");

            btn.disabled = true;
            try {
                const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                await addDoc(gamesRef, {
                    name, 
                    link, 
                    icon: currentIcon || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(name)}`,
                    created_at: serverTimestamp()
                });
                tg.showAlert("Oyun eklendi!");
                document.getElementById('add-name').value = "";
                document.getElementById('add-link').value = "";
                currentIcon = "";
                document.getElementById('icon-preview').classList.add('hidden');
                document.getElementById('icon-hint').classList.remove('hidden');
                toggleAdminPanel(false);
            } catch (e) { 
                tg.showAlert("Hata: " + e.message); 
            } finally {
                btn.disabled = false;
            }
        };

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentIcon = e.target.result;
                    document.getElementById('icon-preview').src = currentIcon;
                    document.getElementById('icon-preview').classList.remove('hidden');
                    document.getElementById('icon-hint').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.toggleAdminPanel = (s) => document.getElementById('admin-panel').classList.toggle('open', s);

        function renderGames() {
            const grid = document.getElementById('game-grid');
            if (!grid) return;
            grid.innerHTML = "";
            
            if (allGames.length === 0) {
                grid.innerHTML = `<p class="text-center text-gray-400 text-sm py-10 italic">Maƒüazada hen√ºz oyun yok.</p>`;
                return;
            }

            allGames.forEach(g => {
                const card = document.createElement('div');
                card.className = "flex items-center justify-between p-4 bg-white border rounded-[2rem] custom-shadow active:scale-95 transition-all animate__animated animate__fadeInUp";
                card.onclick = () => window.open(g.link.startsWith('http') ? g.link : 'https://' + g.link, '_blank');
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <img src="${g.icon}" class="w-16 h-16 rounded-2xl object-cover bg-gray-50 shadow-sm">
                        <h3 class="font-bold text-gray-800 text-lg">${g.name}</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-cyan-500 flex items-center justify-center text-white shadow-lg shadow-cyan-100">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4.516 7.548c0.436-0.446 1.043-0.481 1.576 0L10 11.295l3.908-3.747c0.533-0.481 1.141-0.446 1.574 0 0.436 0.445 0.408 1.197 0 1.615l-4.695 4.502c-0.217 0.223-0.502 0.335-0.787 0.335s-0.57-0.112-0.789-0.335L4.516 9.163c-0.408-0.418-0.436-1.17 0-1.615z"/></svg>
                    </div>`;
                grid.appendChild(card);
            });
        }

        function renderAdminInventory() {
            const inv = document.getElementById('admin-inventory');
            if (!inv) return;
            inv.innerHTML = `<h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-2">Mevcut Oyunlar</h3>`;
            allGames.forEach(g => {
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100 mb-2";
                item.innerHTML = `
                    <span class="text-sm font-bold text-gray-700">${g.name}</span>
                    <button class="text-red-500 text-xs font-black px-4 py-2 bg-red-50 rounded-xl hover:bg-red-100">Sƒ∞L</button>
                `;
                item.querySelector('button').onclick = async () => {
                    if(confirm(`${g.name} silinsin mi?`)) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', g.id));
                    }
                };
                inv.appendChild(item);
            });
        }

        window.addEventListener('load', startApp);
    </script>
</body>
</html>
