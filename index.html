<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KOALA ARCADE | VERIFIED</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.157.0/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@700&family=Space+Grotesk:wght@300;700&display=swap');
        
        :root { --accent: #00ff88; --bg: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Space Grotesk', sans-serif; }
        body { background: var(--bg); color: #fff; overflow: hidden; height: 100vh; }

        /* --- VERIFY SCREEN (DOĞRULAMA) --- */
        #verify-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #koala-3d-container { position: absolute; width: 100%; height: 60%; top: 10%; }
        .verify-content { z-index: 10; text-align: center; margin-top: 250px; }
        .status-text { font-family: 'Syncopate'; font-size: 12px; letter-spacing: 4px; color: var(--accent); margin-bottom: 20px; }

        /* --- GAME UI (OYUN EKRANI) --- */
        #game-screen { display: none; opacity: 0; height: 100vh; padding: 60px 25px; }
        
        .main-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 40px; padding: 30px; text-align: center; backdrop-filter: blur(10px);
        }

        .tap-target {
            width: 240px; height: 240px; margin: 40px auto;
            background: radial-gradient(circle, rgba(0,255,136,0.15) 0%, transparent 70%);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .koala-coin {
            width: 180px; height: 180px; border-radius: 50%; border: 6px solid #1a1a1a;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); transition: transform 0.05s;
        }
        .koala-coin:active { transform: scale(0.92); }

        /* Navigasyon */
        nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; background: rgba(15,15,15,0.9); border-radius: 25px;
            display: flex; padding: 15px; border: 1px solid #222; z-index: 100;
        }
        .nav-btn { flex: 1; text-align: center; color: #555; font-size: 20px; }
        .nav-btn.active { color: var(--accent); }

        /* Floating Text */
        .float-val { position: absolute; color: var(--accent); font-weight: 900; pointer-events: none; animation: up 0.7s forwards; }
        @keyframes up { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div id="verify-screen">
        <div id="koala-3d-container"></div>
        <div class="verify-content">
            <p class="status-text" id="status-label">BAĞLANTI KURULUYOR...</p>
            <div class="w-48 h-1 bg-zinc-900 rounded-full overflow-hidden mx-auto">
                <div id="progress-bar" class="h-full bg-emerald-500 w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <div id="game-screen">
        <div class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-2 bg-zinc-900 px-4 py-2 rounded-full border border-zinc-800">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-[10px] font-bold uppercase tracking-widest" id="ui-handle">@USER</span>
            </div>
            <i class="fa-solid fa-shield-halved text-emerald-500 text-xl"></i>
        </div>

        <div class="main-card">
            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[4px] mb-2">TOPLAM KOALA</p>
            <h1 id="ui-bal" class="text-6xl font-black italic">0</h1>
        </div>

        <div class="tap-target" id="tap-zone">
            <img src="coinkoala.jpg" class="koala-coin" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-zinc-900 p-4 rounded-3xl border border-zinc-800 text-center" onclick="watchAd()">
                <i class="fa-solid fa-rectangle-ad text-emerald-500 mb-2"></i>
                <p class="text-[10px] font-bold uppercase">Reklam İzle</p>
            </div>
            <div class="bg-zinc-900 p-4 rounded-3xl border border-zinc-800 text-center">
                <i class="fa-solid fa-rocket text-orange-500 mb-2"></i>
                <p class="text-[10px] font-bold uppercase">Turbo Aktif</p>
            </div>
        </div>

        <nav>
            <div class="nav-btn active"><i class="fa-solid fa-house"></i></div>
            <div class="nav-btn"><i class="fa-solid fa-tasks"></i></div>
            <div class="nav-btn"><i class="fa-solid fa-users"></i></div>
            <div class="nav-btn"><i class="fa-solid fa-wallet"></i></div>
        </nav>
    </div>

<script>
    // --- FIREBASE VE TG AYARLARI ---
    const firebaseConfig = { apiKey: "AIza...", projectId: "koalascombom" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tg = window.Telegram.WebApp;
    tg.expand();

    let myId = tg.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "DEV_MODE";
    let myHandle = tg.initDataUnsafe?.user?.username ? "@" + tg.initDataUnsafe.user.username : "KoalaUser";
    
    let userData = { bal: 0, handle: myHandle };

    // --- 3D KOALA RENDER (THREE.JS) ---
    function init3D() {
        const container = document.getElementById('koala-3d-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Koala yerine dönen şık bir altın küre/para simülasyonu (Placeholder)
        const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
        const material = new THREE.MeshPhongMaterial({ 
            color: 0x00ff88, 
            emissive: 0x004422,
            shininess: 100, 
            wireframe: true 
        });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(10, 10, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        camera.position.z = 40;

        function animate() {
            requestAnimationFrame(animate);
            mesh.rotation.y += 0.02;
            mesh.rotation.x += 0.01;
            renderer.render(scene, camera);
        }
        animate();
    }

    // --- DOĞRULAMA SÜRECİ ---
    async function startVerify() {
        init3D();
        const bar = document.getElementById('progress-bar');
        const label = document.getElementById('status-label');

        // Adım 1: Bağlantı
        await new Promise(r => setTimeout(r, 1500));
        bar.style.width = "40%";
        label.innerText = "VERİLER ÇEKİLİYOR...";

        // Firebase Veri Çekme
        const doc = await db.collection("users").doc(myId).get();
        if(doc.exists) {
            userData = doc.data();
        } else {
            await db.collection("users").doc(myId).set(userData);
        }

        // Adım 2: Güvenlik
        await new Promise(r => setTimeout(r, 1500));
        bar.style.width = "80%";
        label.innerText = "GÜVENLİK KONTROLÜ...";

        // Adım 3: Tamamlandı
        await new Promise(r => setTimeout(r, 1000));
        bar.style.width = "100%";
        label.innerText = "DOĞRULANDI!";

        // Geçiş Animasyonu
        gsap.to("#verify-screen", { 
            opacity: 0, 
            scale: 1.5, 
            duration: 0.8, 
            onComplete: () => {
                document.getElementById('verify-screen').remove();
                showGame();
            }
        });
    }

    function showGame() {
        const game = document.getElementById('game-screen');
        game.style.display = 'block';
        gsap.to(game, { opacity: 1, duration: 1 });
        renderUI();
    }

    // --- OYUN MEKANİĞİ ---
    const tapZone = document.getElementById('tap-zone');
    tapZone.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        
        // Bakiye artır
        userData.bal += 0.1;
        renderUI();

        // Sayı fırlatma efekti
        const float = document.createElement('div');
        float.className = 'float-val';
        float.innerText = '+0.1';
        float.style.left = touch.pageX + 'px';
        float.style.top = touch.pageY + 'px';
        document.body.appendChild(float);
        setTimeout(() => float.remove(), 700);

        tg.HapticFeedback.impactOccurred('light');
    });

    async function watchAd() {
        userData.bal += 1;
        await db.collection("users").doc(myId).update({ bal: userData.bal });
        renderUI();
        alert("1 Koala Ödül Alındı!");
    }

    function renderUI() {
        document.getElementById('ui-bal').innerText = Math.floor(userData.bal).toLocaleString();
        document.getElementById('ui-handle').innerText = userData.handle;
    }

    // 10 saniyede bir otomatik kaydet
    setInterval(() => {
        if(myId !== "DEV_MODE") {
            db.collection("users").doc(myId).update({ bal: userData.bal });
        }
    }, 10000);

    window.onload = startVerify;
</script>
</body>
</html>
