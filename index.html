<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chalpus Game Store Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-hint-color: #999999;
            --tg-theme-button-color: #00bad4;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            user-select: none;
        }

        .custom-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .search-bar {
            background: var(--tg-theme-secondary-bg-color);
            transition: all 0.3s ease;
        }

        .search-bar:focus-within {
            background: #fff;
            box-shadow: 0 0 0 2px var(--tg-theme-button-color);
        }

        .category-pill {
            transition: all 0.2s;
            white-space: nowrap;
        }

        .category-pill.active {
            background-color: var(--tg-theme-button-color);
            color: white;
        }

        .game-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .game-card:active {
            transform: scale(0.98);
        }

        .banner-container::-webkit-scrollbar { display: none; }

        #admin-panel {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
        }

        #admin-panel.open {
            transform: translateY(0);
        }

        .loader-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="pb-24">

    <!-- Banned Screen -->
    <div id="banned-screen" class="fixed inset-0 bg-white z-[9999] hidden flex-col items-center justify-center p-10 text-center">
        <div class="text-6xl mb-4">üö´</div>
        <h2 class="text-2xl font-bold">Eri≈üim Engellendi</h2>
        <p class="text-gray-500 mt-2">Topluluk kurallarƒ±nƒ± ihlal ettiƒüiniz i√ßin eri≈üiminiz kalƒ±cƒ± olarak kƒ±sƒ±tlanmƒ±≈ütƒ±r.</p>
    </div>

    <!-- Main Content -->
    <div id="app-container" class="max-w-md mx-auto px-4 pt-4">
        
        <!-- Profile & Header -->
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-cyan-100">
                    ?
                </div>
                <div>
                    <p class="text-xs text-gray-400 font-medium">Ho≈ü geldin,</p>
                    <h1 id="user-name" class="font-bold text-gray-800 leading-tight">Oyuncu</h1>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="tg.showAlert('Yakƒ±nda: Ba≈üarƒ±mlar ve Puanlar!')" class="p-2 bg-gray-50 rounded-xl border border-gray-100">
                    üèÜ
                </button>
            </div>
        </header>

        <!-- Search Area -->
        <div class="search-bar flex items-center px-4 py-3 rounded-2xl mb-6">
            <span class="mr-2">üîç</span>
            <input type="text" id="search-input" placeholder="Oyun ara..." class="bg-transparent border-none outline-none w-full text-sm font-medium">
        </div>

        <!-- Banner Carousel -->
        <div class="relative mb-8 overflow-hidden rounded-[2rem] shadow-xl shadow-gray-100">
            <div id="banner-list" class="banner-container flex overflow-x-auto scroll-smooth snap-x snap-mandatory">
                <!-- Banners dynamic -->
            </div>
            <div id="banner-dots" class="absolute bottom-4 left-0 right-0 flex justify-center gap-1.5"></div>
        </div>

        <!-- Categories -->
        <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-4" id="category-list">
            <button class="category-pill active px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('All', this)">T√ºm√º</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Aksiyon', this)">Aksiyon</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Bulmaca', this)">Bulmaca</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Klasik', this)">Klasik</button>
        </div>

        <!-- Games Grid -->
        <div id="game-grid" class="grid grid-cols-1 gap-4">
            <!-- Skeleton items -->
            <div class="loader-skeleton h-24 rounded-3xl w-full"></div>
            <div class="loader-skeleton h-24 rounded-3xl w-full"></div>
        </div>

    </div>

    <!-- Admin Float Button -->
    <button id="admin-float-btn" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-gray-900 text-white rounded-2xl shadow-2xl items-center justify-center z-50 animate__animated animate__bounceIn" onclick="toggleAdminPanel(true)">
        ‚öôÔ∏è
    </button>

    <!-- Admin Panel (Slide-up) -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-[100] flex flex-col pt-safe">
        <div class="px-6 py-4 flex items-center justify-between border-b">
            <h2 class="text-xl font-extrabold italic">ADMIN PANEL <span class="text-cyan-500">v2.0</span></h2>
            <button onclick="toggleAdminPanel(false)" class="p-2 bg-gray-100 rounded-xl">‚úï</button>
        </div>

        <!-- Admin Navigation -->
        <div class="flex p-4 gap-2">
            <button onclick="adminTab('games')" class="admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-900 text-white font-bold text-sm">Oyunlar</button>
            <button onclick="adminTab('users')" class="admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-100 text-gray-500 font-bold text-sm">Kullanƒ±cƒ±lar</button>
            <button onclick="adminTab('stats')" class="admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-100 text-gray-500 font-bold text-sm">Analiz</button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-20">
            <!-- Admin: Games Content -->
            <div id="admin-games-content" class="space-y-6">
                <div class="bg-gray-50 p-5 rounded-[2rem] space-y-4">
                    <h3 class="font-bold text-sm text-gray-400 uppercase tracking-widest">Yeni Oyun Yayƒ±nla</h3>
                    
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                             <div class="w-20 h-20 border-2 border-dashed rounded-2xl flex items-center justify-center cursor-pointer overflow-hidden bg-white" onclick="document.getElementById('icon-input').click()">
                                <img id="icon-preview" class="hidden w-full h-full object-cover">
                                <span id="icon-hint" class="text-[10px] text-gray-400 font-bold">ƒ∞KON</span>
                             </div>
                             <input type="file" id="icon-input" class="hidden" accept="image/*" onchange="previewImage(this, 'icon')">
                        </div>
                        <div class="flex-[2]">
                             <div class="h-20 border-2 border-dashed rounded-2xl flex items-center justify-center cursor-pointer overflow-hidden bg-white" onclick="document.getElementById('banner-input').click()">
                                <img id="banner-preview" class="hidden w-full h-full object-cover">
                                <span id="banner-hint" class="text-[10px] text-gray-400 font-bold">BANNER (GENƒ∞≈û)</span>
                             </div>
                             <input type="file" id="banner-input" class="hidden" accept="image/*" onchange="previewImage(this, 'banner')">
                        </div>
                    </div>

                    <input type="text" id="add-name" placeholder="Oyun Adƒ±" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200 focus:ring-2 focus:ring-cyan-500">
                    <select id="add-category" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200 focus:ring-2 focus:ring-cyan-500 bg-white">
                        <option value="Aksiyon">Aksiyon</option>
                        <option value="Bulmaca">Bulmaca</option>
                        <option value="Klasik">Klasik</option>
                        <option value="Spor">Spor</option>
                    </select>
                    <input type="text" id="add-link" placeholder="Bot Linki (t.me/...)" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200 focus:ring-2 focus:ring-cyan-500">
                    
                    <button onclick="createNewGame()" id="save-btn" class="w-full py-4 bg-cyan-500 text-white rounded-2xl font-black shadow-xl shadow-cyan-100 active:scale-95 transition-all">
                        MAƒûAZAYA EKLE
                    </button>
                </div>

                <div id="admin-inventory" class="space-y-3">
                    <!-- Dynamic inventory -->
                </div>
            </div>

            <!-- Admin: Users Content -->
            <div id="admin-users-content" class="hidden space-y-3">
                <div id="admin-user-list"></div>
            </div>

            <!-- Admin: Stats Content -->
            <div id="admin-stats-content" class="hidden">
                <div class="grid grid-cols-2 gap-4" id="stats-grid">
                    <!-- Stats summary -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, addDoc, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbA61N0ztsdRxEjwMUS0YKXXfXV4DMEVQ",
            authDomain: "playcentr-67140.firebaseapp.com",
            projectId: "playcentr-67140",
            storageBucket: "playcentr-67140.firebasestorage.app",
            messagingSenderId: "306761978239",
            appId: "1:306761978239:web:17d4e797da09fa0b49ca4a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe?.user;
        const ADMIN_ID = "8392479231";

        let allGames = [];
        let currentIcon = "";
        let currentBanner = "";
        let activeCategory = "All";

        async function bootstrap() {
            tg.expand();
            tg.ready();

            if (user) {
                document.getElementById('user-name').innerText = user.first_name;
                document.getElementById('user-avatar').innerText = user.first_name[0];
                
                if (user.id.toString() === ADMIN_ID) {
                    document.getElementById('admin-float-btn').classList.replace('hidden', 'flex');
                }

                const uRef = doc(db, "users", user.id.toString());
                const uSnap = await getDoc(uRef);
                
                if (uSnap.exists() && uSnap.data().isBanned) {
                    document.getElementById('banned-screen').classList.remove('hidden');
                    return;
                }

                await setDoc(uRef, {
                    first_name: user.first_name,
                    username: user.username || "",
                    last_seen: serverTimestamp()
                }, { merge: true });
            }

            // Real-time Listeners
            onSnapshot(collection(db, "apps"), (snap) => {
                allGames = [];
                snap.forEach(d => allGames.push({ id: d.id, ...d.data() }));
                renderGames();
                renderAdminInventory();
                renderBanners();
                renderStats();
            });

            if (user?.id.toString() === ADMIN_ID) {
                onSnapshot(collection(db, "users"), (snap) => {
                    const users = [];
                    snap.forEach(d => users.push({ id: d.id, ...d.data() }));
                    renderAdminUsers(users);
                });
            }

            // Search Logic
            document.getElementById('search-input').addEventListener('input', (e) => {
                renderGames(e.target.value);
            });
        }

        window.toggleAdminPanel = (show) => {
            const panel = document.getElementById('admin-panel');
            show ? panel.classList.add('open') : panel.classList.remove('open');
        };

        window.adminTab = (tab) => {
            ['games', 'users', 'stats'].forEach(t => {
                document.getElementById(`admin-${t}-content`).classList.toggle('hidden', t !== tab);
            });
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                const isActive = btn.innerText.toLowerCase().includes(tab.substring(0,2));
                btn.classList.toggle('bg-gray-900', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('bg-gray-100', !isActive);
                btn.classList.toggle('text-gray-500', !isActive);
            });
        };

        window.previewImage = (input, type) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                if (type === 'icon') {
                    currentIcon = base64;
                    document.getElementById('icon-preview').src = base64;
                    document.getElementById('icon-preview').classList.remove('hidden');
                    document.getElementById('icon-hint').classList.add('hidden');
                } else {
                    currentBanner = base64;
                    document.getElementById('banner-preview').src = base64;
                    document.getElementById('banner-preview').classList.remove('hidden');
                    document.getElementById('banner-hint').classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        };

        window.createNewGame = async () => {
            const name = document.getElementById('add-name').value;
            const category = document.getElementById('add-category').value;
            const link = document.getElementById('add-link').value;
            const btn = document.getElementById('save-btn');

            if (!name || !link) return tg.showAlert("L√ºtfen isim ve link alanlarƒ±nƒ± doldurun.");

            btn.innerText = "YAYINLANIYOR...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "apps"), {
                    name,
                    category,
                    link,
                    icon: currentIcon || `https://api.dicebear.com/7.x/bottts/svg?seed=${name}`,
                    banner: currentBanner,
                    clicks: 0,
                    created_at: serverTimestamp()
                });
                tg.showAlert("Oyun Maƒüazaya Eklendi!");
                document.getElementById('add-name').value = "";
                document.getElementById('add-link').value = "";
                currentIcon = ""; currentBanner = "";
                document.querySelectorAll('#admin-panel img').forEach(i => i.classList.add('hidden'));
                document.querySelectorAll('#admin-panel span').forEach(s => s.classList.remove('hidden'));
            } catch (e) {
                tg.showAlert("Hata: " + e.message);
            } finally {
                btn.innerText = "MAƒûAZAYA EKLE";
                btn.disabled = false;
            }
        };

        window.playGame = async (id, link) => {
            await updateDoc(doc(db, "apps", id), { clicks: increment(1) });
            window.open(link, '_blank');
        };

        window.filterCategory = (cat, btn) => {
            activeCategory = cat;
            document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderGames();
        };

        function renderGames(searchQuery = "") {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            
            const filtered = allGames.filter(g => {
                const matchesSearch = g.name.toLowerCase().includes(searchQuery.toLowerCase());
                const matchesCat = activeCategory === "All" || g.category === activeCategory;
                return matchesSearch && matchesCat;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="text-center py-10 text-gray-400 font-medium">Oyun bulunamadƒ±...</div>`;
                return;
            }

            filtered.forEach(g => {
                grid.innerHTML += `
                    <div class="game-card flex items-center justify-between p-4 bg-white border border-gray-100 rounded-[2rem] custom-shadow" onclick="playGame('${g.id}', '${g.link}')">
                        <div class="flex items-center gap-4">
                            <img src="${g.icon}" class="w-16 h-16 rounded-2xl object-cover bg-gray-50 border border-gray-100 shadow-sm">
                            <div>
                                <h3 class="font-black text-gray-800">${g.name}</h3>
                                <p class="text-[10px] font-bold text-cyan-500 uppercase tracking-tighter">${g.category || 'Klasik'}</p>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-cyan-50 flex items-center justify-center text-cyan-600">
                            ‚ñ∂
                        </div>
                    </div>
                `;
            });
        }

        function renderBanners() {
            const list = document.getElementById('banner-list');
            const dots = document.getElementById('banner-dots');
            list.innerHTML = ""; dots.innerHTML = "";
            
            const bannerGames = allGames.filter(g => g.banner).slice(0, 5);
            
            if (bannerGames.length === 0) {
                document.querySelector('.relative.mb-8').style.display = 'none';
                return;
            }
            document.querySelector('.relative.mb-8').style.display = 'block';

            bannerGames.forEach((g, i) => {
                list.innerHTML += `
                    <div class="min-w-full snap-center h-48 relative cursor-pointer" onclick="playGame('${g.id}', '${g.link}')">
                        <img src="${g.banner}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex flex-col justify-end p-6">
                            <h4 class="text-white font-black text-2xl uppercase italic">${g.name}</h4>
                        </div>
                    </div>
                `;
                dots.innerHTML += `<div class="w-2 h-2 rounded-full ${i === 0 ? 'bg-white w-6' : 'bg-white/40'} transition-all"></div>`;
            });
        }

        function renderAdminInventory() {
            const inv = document.getElementById('admin-inventory');
            inv.innerHTML = `<h3 class="font-bold text-sm text-gray-400 uppercase tracking-widest mt-8">Maƒüaza Stoklarƒ±</h3>`;
            allGames.forEach(g => {
                inv.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl">
                        <div class="flex items-center gap-3 text-sm">
                            <img src="${g.icon}" class="w-10 h-10 rounded-lg">
                            <div>
                                <div class="font-bold">${g.name}</div>
                                <div class="text-[10px] text-gray-400">${g.clicks || 0} tƒ±klama</div>
                            </div>
                        </div>
                        <button onclick="deleteDoc(doc(db, 'apps', '${g.id}'))" class="text-red-500 font-bold text-xs bg-red-50 px-3 py-2 rounded-lg">Kaldƒ±r</button>
                    </div>
                `;
            });
        }

        function renderAdminUsers(users) {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = "";
            users.forEach(u => {
                const banned = u.isBanned || false;
                list.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-white border rounded-2xl ${banned ? 'opacity-50 grayscale' : ''}">
                        <div class="text-sm">
                            <div class="font-bold">${u.first_name} ${u.id === ADMIN_ID ? '‚≠ê' : ''}</div>
                            <div class="text-xs text-gray-400">@${u.username || 'n/a'}</div>
                        </div>
                        ${u.id !== ADMIN_ID ? `
                            <button onclick="updateDoc(doc(db, 'users', '${u.id}'), {isBanned: ${!banned}})" class="px-4 py-2 rounded-xl text-xs font-bold ${banned ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                                ${banned ? 'A√á' : 'BAN'}
                            </button>
                        ` : ''}
                    </div>
                `;
            });
        }

        function renderStats() {
            const grid = document.getElementById('stats-grid');
            const totalClicks = allGames.reduce((acc, g) => acc + (g.clicks || 0), 0);
            grid.innerHTML = `
                <div class="bg-cyan-50 p-6 rounded-3xl">
                    <div class="text-xs text-cyan-600 font-bold uppercase">Toplam Oyun</div>
                    <div class="text-3xl font-black">${allGames.length}</div>
                </div>
                <div class="bg-gray-900 p-6 rounded-3xl text-white">
                    <div class="text-xs text-gray-400 font-bold uppercase">Toplam Tƒ±k</div>
                    <div class="text-3xl font-black">${totalClicks}</div>
                </div>
            `;
        }

        bootstrap();
    </script>
</body>
</html>
