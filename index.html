<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chalpus Game Store Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-hint-color: #999999;
            --tg-theme-button-color: #00bad4;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }

        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            user-select: none;
        }

        .custom-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .search-bar {
            background: var(--tg-theme-secondary-bg-color);
            transition: all 0.3s ease;
        }

        .search-bar:focus-within {
            background: #fff;
            box-shadow: 0 0 0 2px var(--tg-theme-button-color);
        }

        .category-pill {
            transition: all 0.2s;
            white-space: nowrap;
        }

        .category-pill.active {
            background-color: var(--tg-theme-button-color);
            color: white;
        }

        .game-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .game-card:active {
            transform: scale(0.98);
        }

        .banner-container::-webkit-scrollbar { display: none; }

        #admin-panel {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
        }

        #admin-panel.open {
            transform: translateY(0);
        }

        .loader-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="pb-24">

    <!-- Banned Screen -->
    <div id="banned-screen" class="fixed inset-0 bg-white z-[9999] hidden flex-col items-center justify-center p-10 text-center">
        <div class="text-6xl mb-4">üö´</div>
        <h2 class="text-2xl font-bold">Eri≈üim Engellendi</h2>
        <p class="text-gray-500 mt-2">Eri≈üiminiz kƒ±sƒ±tlanmƒ±≈ütƒ±r.</p>
    </div>

    <!-- Main Content -->
    <div id="app-container" class="max-w-md mx-auto px-4 pt-4">
        
        <!-- Profile & Header -->
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div id="user-avatar" class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-cyan-100">
                    ?
                </div>
                <div>
                    <p class="text-xs text-gray-400 font-medium">Ho≈ü geldin,</p>
                    <h1 id="user-name" class="font-bold text-gray-800 leading-tight">Oyuncu</h1>
                </div>
            </div>
        </header>

        <!-- Search Area -->
        <div class="search-bar flex items-center px-4 py-3 rounded-2xl mb-6">
            <span class="mr-2">üîç</span>
            <input type="text" id="search-input" placeholder="Oyun ara..." class="bg-transparent border-none outline-none w-full text-sm font-medium">
        </div>

        <!-- Banner Carousel -->
        <div class="relative mb-8 overflow-hidden rounded-[2rem] shadow-xl shadow-gray-100 hidden" id="banner-wrapper">
            <div id="banner-list" class="banner-container flex overflow-x-auto scroll-smooth snap-x snap-mandatory"></div>
            <div id="banner-dots" class="absolute bottom-4 left-0 right-0 flex justify-center gap-1.5"></div>
        </div>

        <!-- Categories -->
        <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar mb-4" id="category-list">
            <button class="category-pill active px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('All', this)">T√ºm√º</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Aksiyon', this)">Aksiyon</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Bulmaca', this)">Bulmaca</button>
            <button class="category-pill px-5 py-2 rounded-full text-sm font-bold bg-gray-100" onclick="filterCategory('Klasik', this)">Klasik</button>
        </div>

        <!-- Games Grid -->
        <div id="game-grid" class="grid grid-cols-1 gap-4">
            <div class="loader-skeleton h-24 rounded-3xl w-full"></div>
            <div class="loader-skeleton h-24 rounded-3xl w-full"></div>
        </div>
    </div>

    <!-- Admin Float Button -->
    <button id="admin-float-btn" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-gray-900 text-white rounded-2xl shadow-2xl items-center justify-center z-50 animate__animated animate__bounceIn" onclick="toggleAdminPanel(true)">
        ‚öôÔ∏è
    </button>

    <!-- Admin Panel -->
    <div id="admin-panel" class="fixed inset-0 bg-white z-[100] flex flex-col pt-safe">
        <div class="px-6 py-4 flex items-center justify-between border-b">
            <h2 class="text-xl font-extrabold italic">ADMIN PANEL <span class="text-cyan-500">PRO</span></h2>
            <button onclick="toggleAdminPanel(false)" class="p-2 bg-gray-100 rounded-xl">‚úï</button>
        </div>

        <div class="flex p-4 gap-2">
            <button onclick="adminTab('games')" class="admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-900 text-white font-bold text-sm">Oyunlar</button>
            <button onclick="adminTab('users')" class="admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-100 text-gray-500 font-bold text-sm">Kullanƒ±cƒ±lar</button>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-20">
            <div id="admin-games-content" class="space-y-6 pt-4">
                <div class="bg-gray-50 p-5 rounded-[2rem] space-y-4">
                    <h3 class="font-bold text-xs text-gray-400 uppercase tracking-widest">Yeni Oyun Yayƒ±nla</h3>
                    
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                             <div class="w-20 h-20 border-2 border-dashed rounded-2xl flex items-center justify-center cursor-pointer overflow-hidden bg-white" onclick="document.getElementById('icon-input').click()">
                                <img id="icon-preview" class="hidden w-full h-full object-cover">
                                <span id="icon-hint" class="text-[10px] text-gray-400 font-bold">ƒ∞KON</span>
                             </div>
                             <input type="file" id="icon-input" class="hidden" accept="image/*" onchange="previewImage(this, 'icon')">
                        </div>
                        <div class="flex-[2]">
                             <div class="h-20 border-2 border-dashed rounded-2xl flex items-center justify-center cursor-pointer overflow-hidden bg-white" onclick="document.getElementById('banner-input').click()">
                                <img id="banner-preview" class="hidden w-full h-full object-cover">
                                <span id="banner-hint" class="text-[10px] text-gray-400 font-bold">BANNER (OPSƒ∞YONEL)</span>
                             </div>
                             <input type="file" id="banner-input" class="hidden" accept="image/*" onchange="previewImage(this, 'banner')">
                        </div>
                    </div>

                    <input type="text" id="add-name" placeholder="Oyun Adƒ±" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200 focus:ring-2 focus:ring-cyan-500">
                    <select id="add-category" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200 focus:ring-2 focus:ring-cyan-500 bg-white">
                        <option value="Aksiyon">Aksiyon</option>
                        <option value="Bulmaca">Bulmaca</option>
                        <option value="Klasik">Klasik</option>
                        <option value="Spor">Spor</option>
                    </select>
                    <input type="text" id="add-link" placeholder="Bot Linki (t.me/...)" class="w-full p-4 rounded-xl border-none outline-none ring-1 ring-gray-200 focus:ring-2 focus:ring-cyan-500">
                    
                    <button onclick="createNewGame()" id="save-btn" class="w-full py-4 bg-cyan-500 text-white rounded-2xl font-black shadow-xl shadow-cyan-100 active:scale-95 transition-all">
                        MAƒûAZAYA EKLE
                    </button>
                </div>

                <div id="admin-inventory" class="space-y-3"></div>
            </div>

            <div id="admin-users-content" class="hidden space-y-3 pt-4">
                <div id="admin-user-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, addDoc, deleteDoc, updateDoc, increment, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global Veriler
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-store-pro';
        const tg = window.Telegram.WebApp;
        const ADMIN_ID = "8392479231";

        let user = null;
        let allGames = [];
        let currentIcon = "";
        let currentBanner = "";
        let activeCategory = "All";

        // Firebase Auth & Init
        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) setupApp();
                });
            } catch (e) {
                console.error("Auth Error", e);
            }
        }

        async function setupApp() {
            const tgUser = tg.initDataUnsafe?.user;
            
            if (tgUser) {
                document.getElementById('user-name').innerText = tgUser.first_name;
                document.getElementById('user-avatar').innerText = tgUser.first_name[0];
                
                if (tgUser.id.toString() === ADMIN_ID) {
                    document.getElementById('admin-float-btn').classList.replace('hidden', 'flex');
                }

                // Kullanƒ±cƒ± kaydƒ± ve ban kontrol√º
                const uRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', tgUser.id.toString());
                const uSnap = await getDoc(uRef);
                
                if (uSnap.exists() && uSnap.data().isBanned) {
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('banned-screen').classList.remove('hidden');
                    return;
                }

                await setDoc(uRef, {
                    first_name: tgUser.first_name,
                    username: tgUser.username || "",
                    last_seen: serverTimestamp()
                }, { merge: true });
            }

            // Oyunlarƒ± Dinle
            const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
            onSnapshot(gamesRef, (snap) => {
                allGames = [];
                snap.forEach(d => allGames.push({ id: d.id, ...d.data() }));
                renderGames();
                renderBanners();
                renderAdminInventory();
            }, (err) => console.error("Firestore Error:", err));

            // Kullanƒ±cƒ±larƒ± Dinle (Admin ise)
            if (tgUser?.id.toString() === ADMIN_ID) {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                onSnapshot(usersRef, (snap) => {
                    const users = [];
                    snap.forEach(d => users.push({ id: d.id, ...d.data() }));
                    renderAdminUsers(users);
                });
            }
        }

        // Oyun Ekleme Fonksiyonu (G√úNCELLENDƒ∞)
        window.createNewGame = async () => {
            const name = document.getElementById('add-name').value.trim();
            const category = document.getElementById('add-category').value;
            const link = document.getElementById('add-link').value.trim();
            const btn = document.getElementById('save-btn');

            if (!name || !link) {
                tg.showAlert("L√ºtfen isim ve link alanlarƒ±nƒ± doldurun.");
                return;
            }

            btn.innerText = "YAYINLANIYOR...";
            btn.disabled = true;

            try {
                const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                await addDoc(gamesRef, {
                    name,
                    category,
                    link,
                    icon: currentIcon || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(name)}`,
                    banner: currentBanner || "",
                    clicks: 0,
                    created_at: serverTimestamp()
                });

                tg.showAlert("Ba≈üarƒ±yla Eklendi!");
                
                // Formu Temizle
                document.getElementById('add-name').value = "";
                document.getElementById('add-link').value = "";
                currentIcon = ""; currentBanner = "";
                document.getElementById('icon-preview').classList.add('hidden');
                document.getElementById('banner-preview').classList.add('hidden');
                document.getElementById('icon-hint').classList.remove('hidden');
                document.getElementById('banner-hint').classList.remove('hidden');
                
                toggleAdminPanel(false);
            } catch (e) {
                console.error("Save Error:", e);
                tg.showAlert("Ekleme ba≈üarƒ±sƒ±z: " + e.message);
            } finally {
                btn.innerText = "MAƒûAZAYA EKLE";
                btn.disabled = false;
            }
        };

        window.previewImage = (input, type) => {
            const file = input.files[0];
            if (!file) return;
            
            // Boyut kontrol√º (Firestore d√∂k√ºman limiti 1MB)
            if (file.size > 800000) {
                tg.showAlert("G√∂rsel √ßok b√ºy√ºk! L√ºtfen daha k√º√ß√ºk bir dosya se√ßin (Max 800KB).");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                if (type === 'icon') {
                    currentIcon = base64;
                    document.getElementById('icon-preview').src = base64;
                    document.getElementById('icon-preview').classList.remove('hidden');
                    document.getElementById('icon-hint').classList.add('hidden');
                } else {
                    currentBanner = base64;
                    document.getElementById('banner-preview').src = base64;
                    document.getElementById('banner-preview').classList.remove('hidden');
                    document.getElementById('banner-hint').classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        };

        window.toggleAdminPanel = (show) => {
            const panel = document.getElementById('admin-panel');
            show ? panel.classList.add('open') : panel.classList.remove('open');
        };

        window.adminTab = (tab) => {
            document.getElementById('admin-games-content').classList.toggle('hidden', tab !== 'games');
            document.getElementById('admin-users-content').classList.toggle('hidden', tab !== 'users');
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                const isActive = btn.innerText.toLowerCase().includes(tab.substring(0,2));
                btn.className = isActive ? 'admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-900 text-white font-bold text-sm' : 'admin-nav-btn flex-1 py-3 rounded-2xl bg-gray-100 text-gray-500 font-bold text-sm';
            });
        };

        window.playGame = async (gameId, link) => {
            try {
                const gRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
                updateDoc(gRef, { clicks: increment(1) });
                window.open(link.startsWith('http') ? link : 'https://' + link, '_blank');
            } catch (e) { console.error(e); }
        };

        window.filterCategory = (cat, btn) => {
            activeCategory = cat;
            document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderGames();
        };

        function renderGames(queryStr = "") {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            const filtered = allGames.filter(g => {
                const mSearch = g.name.toLowerCase().includes(queryStr.toLowerCase());
                const mCat = activeCategory === "All" || g.category === activeCategory;
                return mSearch && mCat;
            });
            filtered.forEach(g => {
                grid.innerHTML += `
                    <div class="game-card flex items-center justify-between p-4 bg-white border border-gray-100 rounded-[2rem] custom-shadow" onclick="playGame('${g.id}', '${g.link}')">
                        <div class="flex items-center gap-4">
                            <img src="${g.icon}" class="w-16 h-16 rounded-2xl object-cover bg-gray-50 border border-gray-100 shadow-sm">
                            <div>
                                <h3 class="font-black text-gray-800">${g.name}</h3>
                                <p class="text-[10px] font-bold text-cyan-500 uppercase tracking-tighter">${g.category || 'Klasik'}</p>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-cyan-50 flex items-center justify-center text-cyan-600">‚ñ∂</div>
                    </div>`;
            });
        }

        function renderBanners() {
            const wrapper = document.getElementById('banner-wrapper');
            const list = document.getElementById('banner-list');
            const dots = document.getElementById('banner-dots');
            const bannerGames = allGames.filter(g => g.banner).slice(0, 5);
            
            if (bannerGames.length === 0) { wrapper.classList.add('hidden'); return; }
            wrapper.classList.remove('hidden');
            list.innerHTML = ""; dots.innerHTML = "";
            
            bannerGames.forEach((g, i) => {
                list.innerHTML += `
                    <div class="min-w-full snap-center h-48 relative cursor-pointer" onclick="playGame('${g.id}', '${g.link}')">
                        <img src="${g.banner}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex flex-col justify-end p-6">
                            <h4 class="text-white font-black text-2xl uppercase italic">${g.name}</h4>
                        </div>
                    </div>`;
                dots.innerHTML += `<div class="w-2 h-2 rounded-full ${i === 0 ? 'bg-white w-6' : 'bg-white/40'} transition-all"></div>`;
            });
        }

        function renderAdminInventory() {
            const inv = document.getElementById('admin-inventory');
            inv.innerHTML = `<h3 class="font-bold text-xs text-gray-400 uppercase tracking-widest mt-8">Maƒüaza Y√∂netimi</h3>`;
            allGames.forEach(g => {
                inv.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl">
                        <div class="flex items-center gap-3 text-sm">
                            <img src="${g.icon}" class="w-10 h-10 rounded-lg">
                            <div>
                                <div class="font-bold">${g.name}</div>
                                <div class="text-[10px] text-gray-400">${g.clicks || 0} tƒ±k</div>
                            </div>
                        </div>
                        <button onclick="deleteDoc(doc(db, 'artifacts', '${appId}', 'public', 'data', 'games', '${g.id}'))" class="text-red-500 font-bold text-xs bg-red-50 px-3 py-2 rounded-lg">Kaldƒ±r</button>
                    </div>`;
            });
        }

        function renderAdminUsers(users) {
            const list = document.getElementById('admin-user-list');
            list.innerHTML = "";
            users.forEach(u => {
                const banned = u.isBanned || false;
                list.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-white border rounded-2xl ${banned ? 'opacity-50 grayscale' : ''}">
                        <div class="text-sm">
                            <div class="font-bold">${u.first_name} ${u.id === ADMIN_ID ? '‚≠ê' : ''}</div>
                            <div class="text-xs text-gray-400">@${u.username || 'n/a'}</div>
                        </div>
                        ${u.id !== ADMIN_ID ? `
                            <button onclick="updateDoc(doc(db, 'artifacts', '${appId}', 'public', 'data', 'users', '${u.id}'), {isBanned: ${!banned}})" class="px-4 py-2 rounded-xl text-xs font-bold ${banned ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                                ${banned ? 'A√á' : 'BAN'}
                            </button>` : ''}
                    </div>`;
            });
        }

        // Arama Dinleyicisi
        document.getElementById('search-input').addEventListener('input', (e) => renderGames(e.target.value));

        init();
    </script>
</body>
</html>
